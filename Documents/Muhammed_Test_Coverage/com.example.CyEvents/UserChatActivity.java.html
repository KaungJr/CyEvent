<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserChatActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debug</a> &gt; <a href="index.source.html" class="el_package">com.example.CyEvents</a> &gt; <span class="el_source">UserChatActivity.java</span></div><h1>UserChatActivity.java</h1><pre class="source lang-java linenums">package com.example.CyEvents;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.net.Uri;
import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;
import androidx.localbroadcastmanager.content.LocalBroadcastManager;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import com.example.CyEvents.ChatAdapter;
import com.example.CyEvents.ChatMessage;
import com.example.Sign_up_Page.R;
import okhttp3.*;

import java.util.ArrayList;

/**
 * UserChatActivity is an activity that allows users to send and receive messages via WebSocket in a chat interface.
 * It provides functionalities for sending text messages, replying to messages, sending images, and managing message status.
 * The activity also integrates with WebSocket to receive messages and update the UI accordingly.
 */
<span class="fc" id="L31">public class UserChatActivity extends AppCompatActivity implements ChatAdapter.OnMessageClickListener {</span>

    /**
     * The WebSocket URL used for communication.
     */
    private static final String WEBSOCKET_URL = &quot;ws://10.90.73.72:8080/chat/25&quot;;

    private OkHttpClient client;
    private WebSocket webSocket;
    private WebSocketListener webSocketListener;

    private Button sendBtn;
    private Button cancelReplyBtn;
    private Button sendImageBtn;
    private EditText msgEtx;
    private RecyclerView messageRecyclerView;
    private ChatAdapter chatAdapter;
    private ArrayList&lt;ChatMessage&gt; messageHistory;
    private TextView replyContextText;
<span class="fc" id="L50">    private String replyingToMessage = null;</span>
    private BroadcastReceiver webSocketReceiver;
<span class="fc" id="L52">    private String username = &quot;Bobby&quot;;</span>
    /**
     * Initializes the activity and sets up UI components and WebSocket connection.
     *
     * @param savedInstanceState The saved instance state for restoring the previous activity state.
     */
    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="fc" id="L60">        super.onCreate(savedInstanceState);</span>
<span class="fc" id="L61">        setContentView(R.layout.activity_user_chat);</span>

        // Initialize UI components
<span class="fc" id="L64">        sendBtn = findViewById(R.id.sendBtn);</span>
<span class="fc" id="L65">        cancelReplyBtn = findViewById(R.id.cancelReplyBtn);</span>
<span class="fc" id="L66">        sendImageBtn = findViewById(R.id.imageBtn);</span>
<span class="fc" id="L67">        msgEtx = findViewById(R.id.msgEdt);</span>
<span class="fc" id="L68">        messageRecyclerView = findViewById(R.id.messageRecyclerView);</span>
<span class="fc" id="L69">        replyContextText = findViewById(R.id.replyContextText);</span>

<span class="fc" id="L71">        messageHistory = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L72">        chatAdapter = new ChatAdapter(messageHistory, this);</span>
<span class="fc" id="L73">        messageRecyclerView.setLayoutManager(new LinearLayoutManager(this));</span>
<span class="fc" id="L74">        messageRecyclerView.setAdapter(chatAdapter);</span>

        // Set up WebSocket client and listener
<span class="fc" id="L77">        client = new OkHttpClient();</span>
<span class="fc" id="L78">        webSocketListener = new WebSocketListener() {</span>
            @Override
            public void onOpen(WebSocket webSocket, Response response) {
<span class="fc" id="L81">                super.onOpen(webSocket, response);</span>
<span class="fc" id="L82">            }</span>

            @Override
            public void onMessage(WebSocket webSocket, String text) {
<span class="fc" id="L86">                super.onMessage(webSocket, text);</span>
<span class="fc" id="L87">                runOnUiThread(() -&gt; {</span>
                    // Prevent adding duplicate messages by checking if the message already exists in history
<span class="fc bfc" id="L89" title="All 2 branches covered.">                    if (!isDuplicateMessage(text)) {</span>
<span class="fc" id="L90">                        ChatMessage receivedMessage = new ChatMessage(username + &quot;: &quot; + text); // Prefix the message with the sender's name</span>
<span class="fc" id="L91">                        messageHistory.add(receivedMessage);</span>
<span class="fc" id="L92">                        chatAdapter.notifyItemInserted(messageHistory.size() - 1);</span>
<span class="fc" id="L93">                        messageRecyclerView.scrollToPosition(messageHistory.size() - 1);</span>
                    }
<span class="fc" id="L95">                });</span>
<span class="fc" id="L96">            }</span>

            @Override
            public void onFailure(WebSocket webSocket, Throwable t, Response response) {
<span class="nc" id="L100">                super.onFailure(webSocket, t, response);</span>
<span class="nc" id="L101">            }</span>

            @Override
            public void onClosed(WebSocket webSocket, int code, String reason) {
<span class="fc" id="L105">                super.onClosed(webSocket, code, reason);</span>
<span class="fc" id="L106">            }</span>
        };

<span class="fc" id="L109">        Request request = new Request.Builder().url(WEBSOCKET_URL).build();</span>
<span class="fc" id="L110">        webSocket = client.newWebSocket(request, webSocketListener);</span>

        // Set up button listeners
<span class="fc" id="L113">        sendBtn.setOnClickListener(v -&gt; {</span>
<span class="fc" id="L114">            String message = msgEtx.getText().toString();</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">            if (!message.isEmpty()) {</span>
<span class="fc" id="L116">                sendMessageToWebSocket(message);</span>
<span class="fc" id="L117">                ChatMessage chatMessage = new ChatMessage(username + &quot;: &quot; + message); // Prefix the message with the sender's name</span>

<span class="pc bpc" id="L119" title="1 of 2 branches missed.">                if (replyingToMessage != null) {</span>
<span class="nc" id="L120">                    chatMessage = new ChatMessage(username + &quot;: &quot; + message, replyingToMessage);</span>
<span class="nc" id="L121">                    replyingToMessage = null;</span>
<span class="nc" id="L122">                    replyContextText.setText(&quot;&quot;);</span>
<span class="nc" id="L123">                    cancelReplyBtn.setVisibility(View.GONE);</span>
                }

                // Prevent adding duplicate messages
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">                if (!isDuplicateMessage(message)) {</span>
<span class="fc" id="L128">                    messageHistory.add(chatMessage);</span>
<span class="fc" id="L129">                    chatAdapter.notifyItemInserted(messageHistory.size() - 1);</span>
<span class="fc" id="L130">                    messageRecyclerView.scrollToPosition(messageHistory.size() - 1);</span>
<span class="fc" id="L131">                    updateMessageStatus(chatMessage);</span>
                }

<span class="fc" id="L134">                msgEtx.setText(&quot;&quot;);</span>
            }
<span class="fc" id="L136">        });</span>


<span class="pc" id="L139">        sendImageBtn.setOnClickListener(v -&gt; openImagePicker());</span>

<span class="pc" id="L141">        cancelReplyBtn.setOnClickListener(v -&gt; cancelReply());</span>

<span class="fc" id="L143">        webSocketReceiver = new BroadcastReceiver() {</span>
            @Override
            public void onReceive(Context context, Intent intent) {
<span class="nc" id="L146">                String message = intent.getStringExtra(&quot;message&quot;);</span>
<span class="nc bnc" id="L147" title="All 4 branches missed.">                if (message != null &amp;&amp; !isDuplicateMessage(message)) {</span>
<span class="nc" id="L148">                    ChatMessage receivedMessage = new ChatMessage(message);</span>
<span class="nc" id="L149">                    messageHistory.add(receivedMessage);</span>
<span class="nc" id="L150">                    chatAdapter.notifyItemInserted(messageHistory.size() - 1);</span>
<span class="nc" id="L151">                    messageRecyclerView.scrollToPosition(messageHistory.size() - 1);</span>
                }
<span class="nc" id="L153">            }</span>
        };

<span class="fc" id="L156">        LocalBroadcastManager.getInstance(this)</span>
<span class="fc" id="L157">                .registerReceiver(webSocketReceiver, new IntentFilter(&quot;WebSocketMessageReceived&quot;));</span>
<span class="fc" id="L158">    }</span>

    @Override
    protected void onDestroy() {
<span class="fc" id="L162">        super.onDestroy();</span>
<span class="fc" id="L163">        LocalBroadcastManager.getInstance(this).unregisterReceiver(webSocketReceiver);</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">        if (webSocket != null) {</span>
<span class="fc" id="L165">            webSocket.close(1000, &quot;Activity destroyed&quot;);</span>
        }
<span class="fc" id="L167">    }</span>

    /**
     * Checks if the given message is already present in the message history to prevent duplicates.
     *
     * @param message The message to check.
     * @return True if the message is a duplicate, false otherwise.
     */
    private boolean isDuplicateMessage(String message) {
<span class="fc bfc" id="L176" title="All 2 branches covered.">        for (ChatMessage chatMessage : messageHistory) {</span>
            // Check if the message itself is the same as an existing message in the history
<span class="fc bfc" id="L178" title="All 2 branches covered.">            if (chatMessage.getMessage().equals(message)) {</span>
<span class="fc" id="L179">                return true;</span>
            }

            // Check if the message is a reply and the original message matches
<span class="pc bpc" id="L183" title="3 of 4 branches missed.">            if (chatMessage.isReply() &amp;&amp; chatMessage.getReplyText().equals(message)) {</span>
<span class="nc" id="L184">                return true;</span>
            }
<span class="fc" id="L186">        }</span>
<span class="fc" id="L187">        return false;</span>
    }


    private void openImagePicker() {
<span class="nc" id="L192">        Intent intent = new Intent(Intent.ACTION_PICK, android.provider.MediaStore.Images.Media.EXTERNAL_CONTENT_URI);</span>
<span class="nc" id="L193">        startActivityForResult(intent, 100);</span>
<span class="nc" id="L194">    }</span>

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc" id="L198">        super.onActivityResult(requestCode, resultCode, data);</span>
<span class="nc bnc" id="L199" title="All 6 branches missed.">        if (requestCode == 100 &amp;&amp; resultCode == RESULT_OK &amp;&amp; data != null) {</span>
<span class="nc" id="L200">            Uri imageUri = data.getData();</span>
<span class="nc" id="L201">            sendImageMessage(imageUri);</span>
        }
<span class="nc" id="L203">    }</span>

    private void sendImageMessage(Uri imageUri) {
<span class="nc" id="L206">        String imageMessage = imageUri.toString();</span>
        // Create an image message with the URI of the image
<span class="nc" id="L208">        ChatMessage imageMessageObject = new ChatMessage(imageMessage, true);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (!isDuplicateMessage(imageUri.toString())) {</span>
<span class="nc" id="L210">            messageHistory.add(imageMessageObject);</span>
<span class="nc" id="L211">            chatAdapter.notifyItemInserted(messageHistory.size() - 1);</span>
<span class="nc" id="L212">            messageRecyclerView.scrollToPosition(messageHistory.size() - 1);</span>
<span class="nc" id="L213">            updateMessageStatus(imageMessageObject);</span>
        }
<span class="nc" id="L215">    }</span>

    private void updateMessageStatus(ChatMessage message) {
<span class="fc" id="L218">        message.setStatus(ChatMessage.STATUS_SENT);</span>
<span class="fc" id="L219">        chatAdapter.notifyItemChanged(messageHistory.indexOf(message));</span>

<span class="fc" id="L221">        messageRecyclerView.postDelayed(() -&gt; {</span>
<span class="nc" id="L222">            message.setStatus(ChatMessage.STATUS_DELIVERED);</span>
<span class="nc" id="L223">            chatAdapter.notifyItemChanged(messageHistory.indexOf(message));</span>
<span class="nc" id="L224">        }, 2000);</span>
<span class="fc" id="L225">    }</span>

    @Override
    public void onMessageClick(String message, int position) {
<span class="nc" id="L229">        String[] options = {&quot;Reply&quot;, &quot;React&quot;, &quot;Delete&quot;, &quot;Forward&quot;};</span>
<span class="nc" id="L230">        AlertDialog.Builder builder = new AlertDialog.Builder(this);</span>
<span class="nc" id="L231">        builder.setTitle(&quot;Choose an action&quot;);</span>
<span class="nc" id="L232">        builder.setItems(options, (dialog, which) -&gt; {</span>
<span class="nc bnc" id="L233" title="All 5 branches missed.">            switch (which) {</span>
                case 0:
<span class="nc" id="L235">                    replyingToMessage = message;</span>
<span class="nc" id="L236">                    replyContextText.setText(&quot;Replying to: &quot; + message);</span>
<span class="nc" id="L237">                    cancelReplyBtn.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L238">                    break;</span>
                case 1:
<span class="nc" id="L240">                    showEmojiReactionDialog(position);</span>
<span class="nc" id="L241">                    break;</span>
                case 2:
<span class="nc" id="L243">                    messageHistory.remove(position);</span>
<span class="nc" id="L244">                    chatAdapter.notifyItemRemoved(position);</span>
<span class="nc" id="L245">                    break;</span>
                case 3:
<span class="nc" id="L247">                    forwardMessage(position);</span>
                    break;
            }
<span class="nc" id="L250">        });</span>
<span class="nc" id="L251">        builder.show();</span>
<span class="nc" id="L252">    }</span>

    @Override
    public void onDeleteMessage(int position) {
<span class="nc" id="L256">        messageHistory.remove(position);</span>
<span class="nc" id="L257">        chatAdapter.notifyItemRemoved(position);</span>
<span class="nc" id="L258">    }</span>

    private void forwardMessage(int position) {
<span class="nc" id="L261">        ChatMessage originalMessage = messageHistory.get(position);</span>
<span class="nc" id="L262">        ChatMessage forwardedMessage = new ChatMessage(originalMessage.getMessage());</span>
<span class="nc" id="L263">        forwardedMessage.setForwarded(true);</span>
<span class="nc" id="L264">        messageHistory.add(forwardedMessage);</span>
<span class="nc" id="L265">        chatAdapter.notifyItemInserted(messageHistory.size() - 1);</span>
<span class="nc" id="L266">    }</span>

    private void showEmojiReactionDialog(int position) {
<span class="nc" id="L269">        String[] emojis = {&quot;😊&quot;, &quot;😂&quot;, &quot;😢&quot;, &quot;😡&quot;};</span>
<span class="nc" id="L270">        AlertDialog.Builder builder = new AlertDialog.Builder(this);</span>
<span class="nc" id="L271">        builder.setTitle(&quot;Choose an emoji reaction&quot;);</span>
<span class="nc" id="L272">        builder.setItems(emojis, (dialog, which) -&gt; {</span>
<span class="nc" id="L273">            String selectedEmoji = emojis[which];</span>
<span class="nc" id="L274">            ChatMessage message = messageHistory.get(position);</span>
<span class="nc" id="L275">            message.setReaction(selectedEmoji);</span>
<span class="nc" id="L276">            chatAdapter.notifyItemChanged(position);</span>
<span class="nc" id="L277">        });</span>
<span class="nc" id="L278">        builder.show();</span>
<span class="nc" id="L279">    }</span>

    private void sendMessageToWebSocket(String message) {
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">        if (webSocket != null) {</span>
<span class="fc" id="L283">            webSocket.send(message);</span>
        }
<span class="fc" id="L285">    }</span>

    private void cancelReply() {
<span class="nc" id="L288">        replyingToMessage = null;</span>
<span class="nc" id="L289">        replyContextText.setText(&quot;&quot;);</span>
<span class="nc" id="L290">        cancelReplyBtn.setVisibility(View.GONE);</span>
<span class="nc" id="L291">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span>Generated by the Android Gradle plugin 8.7.0</div></body></html>